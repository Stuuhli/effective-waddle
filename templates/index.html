<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ app_title }} · Portal</title>
    <style>
      :root {
        color-scheme: light dark;
        --bg: #0f172a;
        --panel: rgba(15, 23, 42, 0.75);
        --panel-light: rgba(255, 255, 255, 0.9);
        --accent: #38bdf8;
        --accent-dark: #0284c7;
        --text: #f8fafc;
        --text-muted: #cbd5f5;
        font-family: "Inter", "Segoe UI", sans-serif;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: radial-gradient(circle at top, #1e293b, #020617 55%);
        display: flex;
        flex-direction: column;
        color: var(--text);
      }

      .page {
        max-width: 1100px;
        margin: 0 auto;
        padding: 2.5rem 1.5rem 4rem;
        width: 100%;
        box-sizing: border-box;
      }

      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        margin-bottom: 2.5rem;
      }

      header h1 {
        font-size: clamp(1.8rem, 3vw, 2.6rem);
        margin: 0;
        letter-spacing: 0.04em;
      }

      header nav a {
        color: var(--text-muted);
        text-decoration: none;
        padding: 0.35rem 0.75rem;
        border-radius: 999px;
        border: 1px solid transparent;
        transition: all 0.2s ease;
      }

      header nav a:hover,
      header nav a:focus {
        border-color: var(--accent);
        color: var(--text);
      }

      .card {
        background: var(--panel);
        border-radius: 18px;
        padding: 1.75rem;
        box-shadow: 0 25px 50px -12px rgba(2, 6, 23, 0.45);
        backdrop-filter: blur(18px);
        border: 1px solid rgba(148, 163, 184, 0.18);
      }

      .card.light {
        background: var(--panel-light);
        color: #0f172a;
        border-color: rgba(148, 163, 184, 0.3);
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
      }

      .hidden {
        display: none !important;
      }

      form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      label {
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--text-muted);
      }

      input,
      textarea,
      select {
        padding: 0.75rem 0.85rem;
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.3);
        background: rgba(15, 23, 42, 0.6);
        color: var(--text);
        font-size: 1rem;
      }

      input:focus,
      textarea:focus,
      select:focus {
        outline: 2px solid var(--accent);
        outline-offset: 2px;
      }

      button {
        padding: 0.75rem 1rem;
        border-radius: 12px;
        background: linear-gradient(135deg, var(--accent), var(--accent-dark));
        color: #0f172a;
        border: none;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.2s ease;
      }

      button:hover,
      button:focus {
        transform: translateY(-1px);
        box-shadow: 0 12px 35px rgba(56, 189, 248, 0.3);
      }

      .error {
        color: #f87171;
        font-size: 0.9rem;
        min-height: 1.2rem;
      }

      .success {
        color: #4ade80;
        font-size: 0.95rem;
        margin-top: 0.5rem;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        background: rgba(56, 189, 248, 0.15);
        border-radius: 999px;
        padding: 0.35rem 0.85rem;
        font-size: 0.85rem;
      }

      .chat-log {
        border-radius: 14px;
        padding: 1rem;
        background: rgba(15, 23, 42, 0.55);
        border: 1px solid rgba(148, 163, 184, 0.16);
        max-height: 320px;
        overflow-y: auto;
        font-size: 0.95rem;
        line-height: 1.4;
      }

      .chat-entry {
        margin-bottom: 1rem;
      }

      .chat-entry div:last-child {
        white-space: pre-wrap;
      }

      .chat-entry strong {
        display: block;
        margin-bottom: 0.35rem;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.04em;
      }

      .list {
        margin: 0;
        padding-left: 1.2rem;
        color: inherit;
      }

      .list li {
        margin-bottom: 0.4rem;
      }

      @media (max-width: 640px) {
        header {
          flex-direction: column;
          align-items: flex-start;
        }

        .card {
          padding: 1.25rem;
        }

        button {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <header>
        <h1>{{ app_title }}</h1>
        <nav>
          {% if docs_url %}
          <a href="{{ docs_url }}" target="_blank" rel="noreferrer">API&nbsp;Dokumentation</a>
          {% endif %}
        </nav>
      </header>

      <section id="login-section" class="card light">
        <h2>Anmeldung</h2>
        <p>Bitte melden Sie sich mit Ihren Zugangsdaten an, um Chat und Dokumenten-Ingestion zu nutzen.</p>
        <form id="login-form">
          <div>
            <label for="email">E-Mail-Adresse</label>
            <input id="email" name="email" type="email" autocomplete="email" required />
          </div>
          <div>
            <label for="password">Passwort</label>
            <input id="password" name="password" type="password" autocomplete="current-password" required />
          </div>
          <button type="submit">Anmelden</button>
          <div id="login-error" class="error"></div>
        </form>
      </section>

      <section id="dashboard" class="hidden" aria-live="polite">
        <div class="card" style="margin-bottom: 1.5rem;">
          <h2>Willkommen, <span id="user-name"></span></h2>
          <p class="pill" id="user-roles"></p>
        </div>

        <div class="grid">
          <article class="card" id="chat-card">
            <h3>Chat</h3>
            <p>Starte Konversationen und interagiere mit dem RAG- oder GraphRAG-Modell.</p>
            <div style="margin-bottom: 1rem; display: flex; gap: 0.75rem;">
              <button type="button" id="load-sessions">Sitzungen laden</button>
              <button type="button" id="toggle-chat">Chat anzeigen</button>
            </div>
            <div id="chat-panel" class="hidden">
              <form id="create-session-form" style="margin-bottom: 1rem;">
                <label for="session-title">Neue Sitzung</label>
                <input id="session-title" name="title" type="text" placeholder="Optionaler Titel" />
                <button type="submit" style="margin-top: 0.75rem; align-self: flex-start;">Sitzung anlegen</button>
              </form>
              <div class="card" style="background: rgba(15, 23, 42, 0.35); margin-bottom: 1.25rem;">
                <h4>Aktive Sitzungen</h4>
                <ul id="session-list" class="list"></ul>
              </div>
              <form id="send-message-form">
                <label for="session-select">Sitzung auswählen</label>
                <select id="session-select" required></select>
                <label for="message">Nachricht</label>
                <textarea id="message" rows="3" placeholder="Ihre Frage..." required></textarea>
                <label for="mode">Modus (optional)</label>
                <input id="mode" type="text" placeholder="z.B. graphrag" />
                <button type="submit">Antwort anfordern</button>
              </form>
              <div class="chat-log" id="chat-log"></div>
            </div>
          </article>

          <article class="card" id="ingestion-card">
            <h3>Dokumenten-Ingestion</h3>
            <p>Integriere neue Dokumentquellen in deine Wissensbasis.</p>
            <button type="button" id="toggle-ingestion" style="margin-bottom: 1rem;">Ingestion anzeigen</button>
            <div id="ingestion-panel" class="hidden">
              <form id="ingestion-form">
                <label for="source">Quelle / Speicherort</label>
                <input id="source" name="source" type="text" placeholder="s3://bucket/pfad oder ./daten" required />
                <label for="collection">Collections-Name</label>
                <input id="collection" name="collection" type="text" placeholder="z.B. kunden-support" required />
                <button type="submit">Ingestion starten</button>
                <div id="ingestion-feedback" class="success"></div>
              </form>
              <div class="card" style="background: rgba(15, 23, 42, 0.35); margin-top: 1.25rem;">
                <h4>Collections</h4>
                <button type="button" id="refresh-collections" style="margin-bottom: 0.75rem;">Aktualisieren</button>
                <ul id="collection-list" class="list"></ul>
              </div>
            </div>
          </article>
        </div>
      </section>
    </div>

    <script>
      const API_BASE = "{{ api_base }}";
      const loginSection = document.getElementById("login-section");
      const dashboard = document.getElementById("dashboard");
      const loginForm = document.getElementById("login-form");
      const loginError = document.getElementById("login-error");
      const userName = document.getElementById("user-name");
      const userRoles = document.getElementById("user-roles");
      const toggleChatBtn = document.getElementById("toggle-chat");
      const chatPanel = document.getElementById("chat-panel");
      const loadSessionsBtn = document.getElementById("load-sessions");
      const sessionList = document.getElementById("session-list");
      const sessionSelect = document.getElementById("session-select");
      const createSessionForm = document.getElementById("create-session-form");
      const sendMessageForm = document.getElementById("send-message-form");
      const chatLog = document.getElementById("chat-log");
      const ingestionPanel = document.getElementById("ingestion-panel");
      const toggleIngestionBtn = document.getElementById("toggle-ingestion");
      const ingestionForm = document.getElementById("ingestion-form");
      const ingestionFeedback = document.getElementById("ingestion-feedback");
      const refreshCollectionsBtn = document.getElementById("refresh-collections");
      const collectionList = document.getElementById("collection-list");

      let accessToken = "";
      let refreshToken = "";

      function setAuthenticated(state) {
        if (state) {
          loginSection.classList.add("hidden");
          dashboard.classList.remove("hidden");
        } else {
          loginSection.classList.remove("hidden");
          dashboard.classList.add("hidden");
        }
      }

      async function apiFetch(path, options = {}) {
        const headers = options.headers ? { ...options.headers } : {};
        if (accessToken) {
          headers["Authorization"] = `Bearer ${accessToken}`;
        }
        headers["Content-Type"] = "application/json";
        try {
          const response = await fetch(`${API_BASE}${path}`, { ...options, headers });
          if (response.status === 401 && refreshToken) {
            const refreshed = await refreshTokens();
            if (refreshed) {
              return apiFetch(path, options);
            }
          }
          if (!response.ok) {
            const message = await response.text();
            throw new Error(message || `Fehler ${response.status}`);
          }
          return response;
        } catch (error) {
          throw error;
        }
      }

      async function refreshTokens() {
        try {
          const response = await fetch(`${API_BASE}/auth/refresh`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ refresh_token: refreshToken })
          });
          if (!response.ok) {
            throw new Error("Refresh fehlgeschlagen");
          }
          const data = await response.json();
          accessToken = data.access_token;
          refreshToken = data.refresh_token;
          return true;
        } catch (err) {
          console.error("Refresh error", err);
          accessToken = "";
          refreshToken = "";
          setAuthenticated(false);
          loginError.textContent = "Sitzung abgelaufen. Bitte erneut anmelden.";
          return false;
        }
      }

      loginForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        loginError.textContent = "";
        const formData = new FormData(loginForm);
        const payload = {
          email: formData.get("email"),
          password: formData.get("password")
        };
        try {
          const response = await fetch(`${API_BASE}/auth/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          if (!response.ok) {
            const message = await response.text();
            throw new Error(message || "Anmeldung fehlgeschlagen");
          }
          const data = await response.json();
          accessToken = data.access_token;
          refreshToken = data.refresh_token;
          await loadProfile();
          setAuthenticated(true);
          await Promise.all([loadSessions(), loadCollections()]);
          chatPanel.classList.remove("hidden");
          ingestionPanel.classList.remove("hidden");
        } catch (error) {
          console.error(error);
          loginError.textContent = error.message || "Anmeldung fehlgeschlagen";
        }
      });

      async function loadProfile() {
        const response = await apiFetch("/auth/me", { method: "GET" });
        const data = await response.json();
        userName.textContent = data.full_name || data.email;
        userRoles.textContent = data.roles.length ? data.roles.join(" · ") : "Benutzer";
      }

      toggleChatBtn.addEventListener("click", () => {
        chatPanel.classList.toggle("hidden");
      });

      toggleIngestionBtn.addEventListener("click", () => {
        ingestionPanel.classList.toggle("hidden");
      });

      loadSessionsBtn.addEventListener("click", () => {
        loadSessions();
      });

      async function loadSessions() {
        try {
          const response = await apiFetch("/chat/sessions", { method: "GET" });
          const sessions = await response.json();
          renderSessions(sessions);
        } catch (error) {
          console.error("Sitzungen", error);
        }
      }

      function renderSessions(sessions) {
        sessionList.innerHTML = "";
        sessionSelect.innerHTML = "";
        if (!sessions.length) {
          const emptyItem = document.createElement("li");
          emptyItem.textContent = "Keine Sitzungen vorhanden.";
          sessionList.appendChild(emptyItem);
          return;
        }
        sessions.forEach((session) => {
          const li = document.createElement("li");
          const title = document.createElement("strong");
          title.textContent = session.title || "Unbenannt";
          const br = document.createElement("br");
          const meta = document.createElement("small");
          meta.textContent = new Date(session.created_at).toLocaleString();
          li.appendChild(title);
          li.appendChild(br);
          li.appendChild(meta);
          sessionList.appendChild(li);

          const option = document.createElement("option");
          option.value = session.id;
          option.textContent = session.title || session.id;
          sessionSelect.appendChild(option);
        });
      }

      createSessionForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const titleInput = document.getElementById("session-title");
        const title = titleInput.value.trim();
        try {
          await apiFetch("/chat/sessions", {
            method: "POST",
            body: JSON.stringify({ title: title || null })
          });
          titleInput.value = "";
          await loadSessions();
        } catch (error) {
          console.error("Sitzung anlegen", error);
        }
      });

      function appendChatEntry(role, content) {
        const entry = document.createElement("div");
        entry.className = "chat-entry";
        const roleLabel = document.createElement("strong");
        roleLabel.textContent = role;
        const body = document.createElement("div");
        body.textContent = content;
        entry.appendChild(roleLabel);
        entry.appendChild(body);
        chatLog.appendChild(entry);
        chatLog.scrollTop = chatLog.scrollHeight;
        return body;
      }

      sendMessageForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const sessionId = sessionSelect.value;
        const messageInput = document.getElementById("message");
        const modeInput = document.getElementById("mode");
        const message = messageInput.value.trim();
        const mode = modeInput.value.trim() || null;
        if (!sessionId) {
          alert("Bitte zuerst eine Sitzung auswählen.");
          return;
        }
        if (!message) {
          return;
        }
        appendChatEntry("Sie", message);
        messageInput.value = "";
        try {
          const response = await apiFetch(`/chat/${sessionId}/messages`, {
            method: "POST",
            body: JSON.stringify({ query: message, mode })
          });
          if (!response.body) {
            throw new Error("Keine Streaming-Antwort erhalten");
          }
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          const assistantBody = appendChatEntry("Assistent", "");
          let answer = "";
          while (true) {
            const { value, done } = await reader.read();
            if (done) {
              break;
            }
            answer += decoder.decode(value, { stream: true });
            assistantBody.textContent = answer;
          }
          answer += decoder.decode();
          assistantBody.textContent = answer;
        } catch (error) {
          console.error("Nachricht senden", error);
        }
      });

      ingestionForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        ingestionFeedback.textContent = "";
        const sourceInput = document.getElementById("source");
        const collectionInput = document.getElementById("collection");
        const source = sourceInput.value.trim();
        const collection = collectionInput.value.trim();
        if (!source || !collection) {
          return;
        }
        try {
          const response = await apiFetch("/ingestion/jobs", {
            method: "POST",
            body: JSON.stringify({ source, collection_name: collection })
          });
          const data = await response.json();
          ingestionFeedback.textContent = `Job ${data.id} gestartet (Status: ${data.status}).`;
          await loadCollections();
        } catch (error) {
          ingestionFeedback.textContent = "Job konnte nicht erstellt werden.";
          console.error(error);
        }
      });

      refreshCollectionsBtn.addEventListener("click", () => {
        loadCollections();
      });

      async function loadCollections() {
        try {
          const response = await apiFetch("/ingestion/collections", { method: "GET" });
          const collections = await response.json();
          renderCollections(collections);
        } catch (error) {
          console.error("Collections", error);
        }
      }

      function renderCollections(collections) {
        collectionList.innerHTML = "";
        if (!collections.length) {
          const li = document.createElement("li");
          li.textContent = "Noch keine Collections vorhanden.";
          collectionList.appendChild(li);
          return;
        }
        collections.forEach((item) => {
          const li = document.createElement("li");
          const strong = document.createElement("strong");
          strong.textContent = item.name;
          li.appendChild(strong);
          const text = document.createTextNode(`: ${item.document_count} Dokument(e)`);
          li.appendChild(text);
          collectionList.appendChild(li);
        });
      }
    </script>
  </body>
</html>
