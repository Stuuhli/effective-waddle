{% extends "base.html" %}

{% block title %}RAG Platform – Admin Console{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{{ url_for('frontend_static', path='ingestion.css') }}" />
    <link rel="stylesheet" href="{{ url_for('frontend_static', path='admin.css') }}" />
{% endblock %}

{% block body %}
    <header class="workspace-header">
      <div class="workspace-header__lead">
        <h1>Admin Console</h1>
        <p>Review accounts, assign roles, and control which collections each role can access.</p>
      </div>
      <div class="workspace-header__meta">
        <span class="workspace-pill">Accounts</span>
        <span class="workspace-pill">Collections</span>
      </div>
      <div class="workspace-header__actions">
        <a class="button button--ghost" href="/frontend/chat" data-prefetch="hover">Back to Chat</a>
      </div>
    </header>

    <div class="ingestion-layout smoke-panel admin-layout">
      <section class="ingestion-panel admin-panel admin-panel--compact" aria-labelledby="user-admin-heading">
        <header class="panel-heading">
          <div>
            <h2 id="user-admin-heading">Account management</h2>
            <p>Assign platform roles to manage access to ingestion, chat, and GraphRAG.</p>
          </div>
          <div class="panel-heading__actions">
            <button class="button button--ghost" type="button" id="refresh-users">Refresh</button>
          </div>
        </header>
        <div class="panel-content">
          <section class="admin-card" aria-labelledby="user-table-heading" data-equal-row="row-1">
            <div class="admin-card__header">
              <h3 id="user-table-heading">Current users</h3>
              <p>Users inherit features from the roles shown below.</p>
            </div>
            <div class="table-scroll">
              <table class="admin-table" id="user-table">
                <thead>
                  <tr>
                    <th scope="col">Email</th>
                    <th scope="col">Roles</th>
                    <th scope="col">Status</th>
                    <th scope="col" class="admin-table__actions">Actions</th>
                  </tr>
                </thead>
                <tbody id="user-table-body">
                  <tr>
                    <td colspan="4" class="admin-table__empty">Loading users…</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>

          <form class="admin-form" id="user-role-form" data-equal-row="row-2">
            <fieldset class="admin-form__fieldset">
              <legend>Assign roles to a user</legend>
              <div class="admin-form__grid">
                <label class="admin-form__field">
                  <span>User</span>
                  <select id="user-select" name="user" required>
                    <option value="">Select a user…</option>
                  </select>
                </label>
                <div class="admin-form__field" id="user-role-field">
                  <span>Roles</span>
                  <div class="role-checkboxes" id="user-role-options" data-role-checkboxes="user"></div>
                </div>
              </div>
              <div class="admin-form__actions">
                <button class="button button--primary" type="submit">Save roles</button>
                <button class="button button--ghost" type="button" id="reset-user-form">Reset</button>
              </div>
              <p class="form-status" id="user-role-status" role="status" aria-live="polite"></p>
            </fieldset>
          </form>

          <form class="admin-form" id="create-role-form" data-equal-row="row-3">
            <fieldset class="admin-form__fieldset">
              <legend>Create a new role</legend>
              <div class="admin-form__grid admin-form__grid--compact">
                <label class="admin-form__field">
                  <span>Role name</span>
                  <input type="text" name="role-name" id="role-name" placeholder="e.g. auditor" required />
                </label>
                <label class="admin-form__field">
                  <span>Description</span>
                  <input type="text" name="role-description" id="role-description" placeholder="Optional" />
                </label>
              </div>
              <div class="admin-form__actions">
                <button class="button button--ghost" type="submit">Create role</button>
              </div>
              <p class="form-status" id="create-role-status" role="status" aria-live="polite"></p>
            </fieldset>
          </form>
        </div>
      </section>

      <section class="ingestion-panel admin-panel admin-panel--compact" aria-labelledby="collection-admin-heading">
        <header class="panel-heading">
          <div>
            <h2 id="collection-admin-heading">Collection access</h2>
            <p>Bind collections to roles to control who can ingest or query specific datasets.</p>
          </div>
          <div class="panel-heading__actions">
            <button class="button button--ghost" type="button" id="refresh-collections">Refresh</button>
          </div>
        </header>
        <div class="panel-content">
          <section class="admin-card" aria-labelledby="collection-table-heading" data-equal-row="row-1">
            <div class="admin-card__header">
              <h3 id="collection-table-heading">Collections</h3>
              <p>Each collection can be accessed by the roles shown below.</p>
            </div>
            <div class="table-scroll">
              <table class="admin-table" id="collection-table">
                <thead>
                  <tr>
                    <th scope="col">Name</th>
                    <th scope="col">Roles</th>
                    <th scope="col">Documents</th>
                    <th scope="col" class="admin-table__actions">Actions</th>
                  </tr>
                </thead>
                <tbody id="collection-table-body">
                  <tr>
                    <td colspan="4" class="admin-table__empty">Loading collections…</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>

          <form class="admin-form" id="create-collection-form" data-equal-row="row-2">
            <fieldset class="admin-form__fieldset">
              <legend>Create collection</legend>
              <div class="admin-form__grid admin-form__grid--compact">
                <label class="admin-form__field">
                  <span>Name</span>
                  <input type="text" name="collection-name" id="collection-name" placeholder="e.g. finance" required />
                </label>
                <label class="admin-form__field">
                  <span>Description</span>
                  <input type="text" name="collection-description" id="collection-description" placeholder="Optional" />
                </label>
              </div>
              <div class="admin-form__field">
                <span>Initial roles</span>
                <div class="role-checkboxes" id="collection-create-role-options" data-role-checkboxes="collection-create"></div>
              </div>
              <div class="admin-form__actions">
                <button class="button button--ghost" type="submit">Create collection</button>
              </div>
              <p class="form-status" id="create-collection-status" role="status" aria-live="polite"></p>
            </fieldset>
          </form>

          <form class="admin-form" id="collection-role-form" data-equal-row="row-3">
            <fieldset class="admin-form__fieldset">
              <legend>Update collection access</legend>
              <div class="admin-form__grid">
                <label class="admin-form__field">
                  <span>Collection</span>
                  <select id="collection-select" name="collection" required>
                    <option value="">Select a collection…</option>
                  </select>
                </label>
                <div class="admin-form__field">
                  <span>Roles</span>
                  <div class="role-checkboxes" id="collection-role-options" data-role-checkboxes="collection"></div>
                </div>
              </div>
              <div class="admin-form__actions">
                <button class="button button--primary" type="submit">Save changes</button>
                <button class="button button--ghost" type="button" id="reset-collection-form">Reset</button>
              </div>
              <p class="form-status" id="collection-role-status" role="status" aria-live="polite"></p>
            </fieldset>
          </form>
        </div>
      </section>

      <section class="ingestion-panel admin-panel" aria-labelledby="graphrag-admin-heading">
        <header class="panel-heading">
          <div>
            <h2 id="graphrag-admin-heading">GraphRAG operations</h2>
            <p>Review configured defaults and run maintenance commands for the GraphRAG workspace.</p>
          </div>
        </header>
        <div class="panel-content">
          <section class="admin-card" aria-labelledby="graphrag-defaults-heading">
            <div class="admin-card__header">
              <h3 id="graphrag-defaults-heading">Configured defaults</h3>
              <p>Fields left blank below fall back to these application settings.</p>
            </div>
            <dl class="graphrag-defaults">
              <div class="graphrag-defaults__item">
                <dt>Workspace root</dt>
                <dd>{{ graphrag_settings.root }}</dd>
              </div>
              <div class="graphrag-defaults__item">
                <dt>Settings file</dt>
                <dd>
                  {% if graphrag_settings.config_name %}
                    {{ graphrag_settings.config_name }}
                  {% else %}
                    settings_local.yaml
                  {% endif %}
                </dd>
              </div>
              <div class="graphrag-defaults__item">
                <dt>Default query mode</dt>
                <dd>{{ graphrag_settings.default_mode | title }}</dd>
              </div>
              <div class="graphrag-defaults__item">
                <dt>Response type</dt>
                <dd>{{ graphrag_settings.response_type }}</dd>
              </div>
              <div class="graphrag-defaults__item">
                <dt>Community level</dt>
                <dd>{{ graphrag_settings.community_level }}</dd>
              </div>
              <div class="graphrag-defaults__item">
                <dt>Verbose logging</dt>
                <dd>{{ 'Enabled' if graphrag_settings.verbose else 'Disabled' }}</dd>
              </div>
            </dl>
            <p class="graphrag-defaults__hint">Overrides entered below apply only to the submitted command.</p>
          </section>

          <form class="admin-form" id="graphrag-prompt-form">
            <fieldset class="admin-form__fieldset">
              <legend>Run prompt tuning</legend>
              <div class="admin-form__grid admin-form__grid--compact">
                <label class="admin-form__field">
                  <span>Config override</span>
                  {% set current_config = graphrag_settings.config %}
                  <select name="graphrag-config">
                    <option value="graphrag_workspace/settings_local.yaml" {% if not current_config or current_config.endswith('settings_local.yaml') %}selected{% endif %}>settings_local.yaml</option>
                    <option value="graphrag_workspace/settings_HPC.yaml" {% if current_config and current_config.endswith('settings_HPC.yaml') %}selected{% endif %}>settings_HPC.yaml</option>
                  </select>
                  <span class="admin-form__hint">Choose the GraphRAG settings profile.</span>
                </label>
              </div>
              <div class="admin-form__grid admin-form__grid--compact">
                <label class="admin-form__field">
                  <span>Domain filter</span>
                  <input type="text" name="graphrag-domain" placeholder="Optional domain" autocomplete="off" />
                  <span class="admin-form__hint">Optional. Restrict prompt tuning to a specific domain.</span>
                </label>
                <label class="admin-form__field">
                  <span>Result limit</span>
                  <input type="number" name="graphrag-limit" min="1" step="1" placeholder="e.g. 5" />
                  <span class="admin-form__hint">Optional positive integer.</span>
                </label>
                <label class="admin-form__field">
                  <span>Verbosity</span>
                  <select name="graphrag-verbose">
                    <option value="default">
                      Use platform default ({{ 'enabled' if graphrag_settings.verbose else 'disabled' }})
                    </option>
                    <option value="true">Force verbose output</option>
                    <option value="false">Suppress verbose output</option>
                  </select>
                </label>
              </div>
              <div class="admin-form__actions">
                <button class="button button--ghost" type="submit">Run prompt tuning</button>
                <button class="button button--ghost" type="button" id="reset-graphrag-prompt">Reset</button>
              </div>
              <p class="form-status" id="graphrag-prompt-status" role="status" aria-live="polite"></p>
              <div class="command-output" id="graphrag-prompt-output" aria-live="polite"></div>
            </fieldset>
          </form>

          <form class="admin-form" id="graphrag-index-form">
            <fieldset class="admin-form__fieldset">
              <legend>Rebuild GraphRAG index</legend>
              <div class="admin-form__grid admin-form__grid--compact">
                <label class="admin-form__field">
                  <span>Config override</span>
                  {% set current_index_config = graphrag_settings.config %}
                  <select name="graphrag-index-config">
                    <option value="graphrag_workspace/settings_local.yaml" {% if not current_index_config or current_index_config.endswith('settings_local.yaml') %}selected{% endif %}>settings_local.yaml</option>
                    <option value="graphrag_workspace/settings_HPC.yaml" {% if current_index_config and current_index_config.endswith('settings_HPC.yaml') %}selected{% endif %}>settings_HPC.yaml</option>
                  </select>
                  <span class="admin-form__hint">Choose the GraphRAG settings profile.</span>
                </label>
                <label class="admin-form__field">
                  <span>Verbosity</span>
                  <select name="graphrag-index-verbose">
                    <option value="default">
                      Use platform default ({{ 'enabled' if graphrag_settings.verbose else 'disabled' }})
                    </option>
                    <option value="true">Force verbose output</option>
                    <option value="false">Suppress verbose output</option>
                  </select>
                </label>
              </div>
              <label class="admin-form__checkbox">
                <input type="checkbox" name="graphrag-reset" />
                <div>
                  <span>Reset index before rebuilding</span>
                  <span class="admin-form__hint">Deletes existing GraphRAG artefacts prior to indexing.</span>
                </div>
              </label>
              <div class="admin-form__actions">
                <button class="button button--ghost" type="submit">Run indexing</button>
                <button class="button button--ghost" type="button" id="reset-graphrag-index">Reset</button>
              </div>
              <p class="form-status" id="graphrag-index-status" role="status" aria-live="polite"></p>
              <div class="command-output" id="graphrag-index-output" aria-live="polite"></div>
            </fieldset>
          </form>
        </div>
      </section>
    </div>
{% endblock %}

{% block scripts %}
    <script defer src="{{ url_for('frontend_static', path='admin.js') }}"></script>
{% endblock %}
