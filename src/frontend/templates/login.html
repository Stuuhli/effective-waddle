<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>RAG Platform – Login</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('frontend_static', path='base.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('frontend_static', path='login.css') }}"
    />
  </head>
  <body>
    <main class="page">
      <section class="card smoke-panel">
        <header class="card__header">
          <div class="card__badge">KiRa - KISTERS RAG PLATFORM</div>
          <h1 class="card__title">Welcome back</h1>
          <p class="card__subtitle">
            Please log in to access admin, retrieval, and ingestion features.
          </p>
        </header>
        <form id="login-form" class="form" action="/auth/jwt/login" method="post">
          <div class="form__field">
            <label class="form__label" for="email">E-Mail</label>
            <div class="input-wrapper">
              <input
                id="email"
                type="email"
                name="username"
                placeholder="du@example.com"
                autocomplete="email"
                required
              />
            </div>
          </div>
          <div class="form__field">
            <label class="form__label" for="password">Passwort</label>
            <div class="input-wrapper input-wrapper--password">
              <input
                id="password"
                type="password"
                name="password"
                placeholder="••••••••"
                autocomplete="current-password"
                required
              />
              <button class="toggle-password" type="button" aria-label="Show password">
                <span class="toggle-password__icon" aria-hidden="true"></span>
              </button>
            </div>
          </div>
          <button class="button" type="submit">Log in</button>
        </form>
        <section class="status" id="status" role="status" aria-live="polite">
          <p class="status__message">Please log in with your credentials.</p>
        </section>
        <section class="response" aria-live="polite">
          <header class="response__header">
            <h2>Token Response</h2>
            <button class="response__copy" id="copy-response" type="button">Copy</button>
          </header>
          <pre class="response__body" id="response-body">{}</pre>
        </section>
      </section>
    </main>
    <script>
      const form = document.getElementById('login-form');
      const statusBox = document.getElementById('status');
      const statusMessage = statusBox ? statusBox.querySelector('.status__message') : null;
      const responseBody = document.getElementById('response-body');
      const copyButton = document.getElementById('copy-response');
      const passwordInput = document.getElementById('password');
      const togglePassword = document.querySelector('.toggle-password');

      function setStatus(message, type = 'info') {
        if (statusBox) {
          statusBox.dataset.state = type;
        }
        if (statusMessage) {
          statusMessage.textContent = message;
        }
      }

      function formatResponse(data) {
        try {
          return JSON.stringify(data, null, 2);
        } catch (error) {
          return String(data);
        }
      }

      if (togglePassword && passwordInput) {
        togglePassword.addEventListener('click', () => {
          const isPassword = passwordInput.type === 'password';
          passwordInput.type = isPassword ? 'text' : 'password';
          togglePassword.setAttribute(
            'aria-label',
            isPassword ? 'Hide password' : 'Show password'
          );
          togglePassword.classList.toggle('toggle-password--visible', isPassword);
        });
      }

      if (copyButton && responseBody) {
        copyButton.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(responseBody.textContent || '{}');
            copyButton.textContent = 'Copied';
            setTimeout(() => {
              copyButton.textContent = 'Copy';
            }, 1500);
          } catch (error) {
            copyButton.textContent = 'Error';
            setTimeout(() => {
              copyButton.textContent = 'Copy';
            }, 1500);
          }
        });
      } else if (copyButton) {
        copyButton.disabled = true;
      }

      if (!form) {
        console.error('Login form not found. Unable to process login.');
      } else {
        form.addEventListener('submit', async (event) => {
          event.preventDefault();
          setStatus('Logging in …', 'info');
          if (responseBody) {
            responseBody.textContent = '{}';
          }

          const formData = new FormData(form);
          const payload = new URLSearchParams();
          formData.forEach((value, key) => {
            if (typeof value === 'string') {
              payload.append(key, value);
            }
          });
          if (!payload.has('grant_type')) {
            payload.append('grant_type', 'password');
          }

          try {
            const response = await fetch(form.action, {
              method: 'POST',
              headers: {
                Accept: 'application/json',
              },
              credentials: 'same-origin',
              body: payload,
            });

            if (!response.ok) {
              const errorPayload = await response.json().catch(() => ({}));
              const message = errorPayload.detail || errorPayload.message || response.statusText;
              setStatus(`Login failed: ${message}`, 'error');
              if (responseBody) {
                responseBody.textContent = formatResponse(errorPayload);
              }
              return;
          }

          const data = await response.json();
          setStatus('Login successful. Tokens have been generated.', 'success');
          if (responseBody) {
            responseBody.textContent = formatResponse(data);
          }

          const accessToken = data?.access_token || '';
          const refreshToken = data?.refresh_token || '';
          if (accessToken) {
            document.cookie = 'rag_token=; Max-Age=0; Path=/; SameSite=Lax;';
            document.cookie = `rag_token=${accessToken}; Path=/; SameSite=Lax; Max-Age=1800;`;
          }
          if (refreshToken) {
            document.cookie = 'rag_refresh=; Max-Age=0; Path=/; SameSite=Lax;';
            document.cookie = `rag_refresh=${refreshToken}; Path=/; SameSite=Lax;`;
          }

          let adminFlag = false;
          if (accessToken) {
            try {
              const profileResponse = await fetch('/auth/me', {
                headers: {
                  Accept: 'application/json',
                  Authorization: `Bearer ${accessToken}`,
                },
              });
              if (profileResponse.ok) {
                const profile = await profileResponse.json();
                adminFlag = Array.isArray(profile?.roles) && profile.roles.includes('admin');
              }
            } catch (profileError) {
              console.error('Failed to load profile after login', profileError);
            }
          }

          document.cookie = 'rag_admin=; Max-Age=0; Path=/; SameSite=Lax;';
          document.cookie = `rag_admin=${adminFlag ? '1' : '0'}; Path=/; SameSite=Lax; Max-Age=1800;`;

          setTimeout(() => {
            window.location.assign('/frontend/chat');
          }, 600);
        } catch (error) {
          setStatus(`Unexpected error: ${error}`, 'error');
        }
      });
      }
    </script>
  </body>
</html>
