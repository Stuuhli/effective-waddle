{% extends "base.html" %}

{% block title %}RAG Platform – Ingestion{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{{ url_for('frontend_static', path='ingestion.css') }}" />
{% endblock %}

{% block body %}
    <header class="workspace-header" id="ingestion-header">
      <div class="workspace-header__lead">
        <h1>Ingestion Workflow</h1>
        <p>Scan PDFs with Docling, chunk intelligently, and feed collections ready for retrieval.</p>
      </div>
      <div class="workspace-header__meta">
        <span class="workspace-pill">Docling pipeline</span>
        <span class="workspace-pill">Chunking with citations</span>
      </div>
      <div class="workspace-header__actions">
        <a class="button button--ghost" href="/frontend/chat" data-prefetch="hover">Back to Chat</a>
      </div>
    </header>

    <div class="ingestion-layout smoke-panel" id="ingestion-layout">
      <section class="ingestion-panel ingestion-panel--input">
        <header class="panel-heading">
          <div>
            <h2>Document Intake</h2>
            <p>Drop PDFs or browse files. Each document will be parsed by Docling prior to chunking.</p>
          </div>
          <div class="panel-heading__actions">
            <input class="visually-hidden" id="file-input" type="file" accept="application/pdf" multiple />
            <button class="button button--ghost" id="file-browse" type="button">Browse files</button>
            <button class="button button--ghost" id="file-clear" type="button" disabled>Clear</button>
          </div>
        </header>

        <div class="dropzone" id="dropzone" role="button" tabindex="0">
          <span class="dropzone__icon"></span>
          <p class="dropzone__text">
            Drag & drop PDF documents here <br />or click to add them to the queue.
          </p>
          <p class="dropzone__hint">Docling will classify layout, extract text, tables, and figures.</p>
        </div>

        <ul class="file-list" id="file-list" aria-live="polite"></ul>

        <form class="config" id="ingestion-config">
          <h3>Chunking strategy</h3>
          <div class="config__grid">
            <label class="config__field">
              <span>Chunk size (characters)</span>
              <input
                type="number"
                name="chunk_size"
                value="{{ chunk_defaults.size }}"
                min="100"
                max="2000"
                step="50"
                required
              />
            </label>
            <label class="config__field">
              <span>Chunk overlap (characters)</span>
              <input
                type="number"
                name="chunk_overlap"
                value="{{ chunk_defaults.overlap }}"
                min="0"
                max="500"
                step="10"
                required
              />
            </label>
            <label class="config__field">
              <span>Collection</span>
              <select name="collection" id="collection-select" required>
                <option value="">Select a collection…</option>
                {% for collection in collections %}
                  <option
                    value="{{ collection.name }}"
                    data-default-size="{{ collection.default_chunk_size }}"
                    data-default-overlap="{{ collection.default_chunk_overlap }}"
                  >
                    {{ collection.name }} • {{ collection.document_count }} docs
                  </option>
                {% endfor %}
              </select>
            </label>
            <label class="config__toggle">
              <input type="checkbox" name="include_tables" checked />
              <span>Preserve tables & figures (Docling structured output)</span>
            </label>
            <label class="config__toggle">
              <input type="checkbox" name="generate_citations" checked />
              <span>Generate citation metadata for each chunk</span>
            </label>
          </div>
        </form>
      </section>

      <section class="ingestion-panel ingestion-panel--workflow" id="workflow-panel">
        <header class="panel-heading">
          <div>
            <h2>Pipeline Orchestration</h2>
            <p>Kick off the ingestion workflow, monitor Docling parsing, chunking and citation extraction.</p>
          </div>
          <div class="panel-heading__actions">
            <button class="button button--ghost" id="reset-workflow" type="button">Reset</button>
            <button class="button button--primary" id="run-workflow" type="button" disabled>
              <span class="icon icon--spark"></span>
              Run ingestion
            </button>
          </div>
        </header>

        <ol class="pipeline" id="pipeline">
          <li class="pipeline__step" data-step="docling">
            <div class="pipeline__status">Pending</div>
            <div class="pipeline__content">
              <h3>Docling parse</h3>
              <p>Convert PDFs to Docling JSON, classify layout blocks, detect tables, assign reading order.</p>
              <pre class="pipeline__code" aria-hidden="true">docling.parse(document)</pre>
            </div>
          </li>
          <li class="pipeline__step" data-step="chunking">
            <div class="pipeline__status">Pending</div>
            <div class="pipeline__content">
              <h3>Chunk assembly</h3>
              <p>Segment semantic chunks with sliding windows using configured size & overlap.</p>
              <pre class="pipeline__code">docling.make_chunks(size, overlap)</pre>
            </div>
          </li>
          <li class="pipeline__step" data-step="embeddings">
            <div class="pipeline__status">Pending</div>
            <div class="pipeline__content">
              <h3>Embedding & indexing</h3>
              <p>Embed each chunk with the active model, stage payloads, upsert into vector store collection.</p>
              <pre class="pipeline__code">vector_index.upsert(chunks)</pre>
            </div>
          </li>
          <li class="pipeline__step" data-step="citations">
            <div class="pipeline__status">Pending</div>
            <div class="pipeline__content">
              <h3>Citation enrichment</h3>
              <p>Link chunk spans back to document coordinates and build citation graph for downstream usage.</p>
              <pre class="pipeline__code">citation_engine.create_links(chunks)</pre>
            </div>
          </li>
        </ol>

        <section class="workflow-preview" id="workflow-preview">
          <header>
            <h3>Preview</h3>
            <p>Docling artefacts, chunk statistics and citation stubs appear here once the workflow runs.</p>
          </header>
          <div class="preview-grid">
            <article class="preview-card" id="preview-docling">
              <h4>Docling extract</h4>
              <pre>{"status": "waiting for run"}</pre>
            </article>
            <article class="preview-card" id="preview-chunks">
              <h4>Chunk summary</h4>
              <pre>{"status": "waiting for run"}</pre>
            </article>
            <article class="preview-card" id="preview-citations">
              <h4>Citations</h4>
              <pre>{"status": "waiting for run"}</pre>
            </article>
          </div>
        </section>

        <section class="job-history">
          <header>
            <h3>Ingested documents</h3>
            <button class="link-button" id="refresh-jobs" type="button">Refresh</button>
          </header>
          <table>
            <thead>
              <tr>
                <th scope="col">Job ID</th>
                <th scope="col">Source</th>
                <th scope="col">Collection</th>
                <th scope="col">Status</th>
                <th scope="col">Updated</th>
                <th scope="col" class="job-actions-header">Actions</th>
              </tr>
            </thead>
            <tbody id="job-table-body">
              {% if recent_jobs %}
                {% for job in recent_jobs %}
                  <tr data-job-id="{{ job.id }}">
                    <td>{{ job.id }}</td>
                    <td class="job-source">{{ job.source }}</td>
                    <td>{{ job.collection }}</td>
                    <td class="job-status"><span class="status-pill status-pill--{{ job.status }}">{{ job.status }}</span></td>
                    <td class="job-updated">{{ job.updated_at }}</td>
                    <td class="job-actions">
                      <button
                        class="icon-button icon-button--danger"
                        type="button"
                        data-job-id="{{ job.id }}"
                        data-action="delete-job"
                        aria-label="Delete document {{ job.source }}"
                        title="Delete document">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="currentColor"><path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/></svg>
                      </button>
                    </td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr class="job-table__empty-row">
                  <td colspan="6" class="job-table__empty">No ingested documents yet.</td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </section>
      </section>
    </div>
{% endblock %}

{% block scripts %}
    <script defer src="{{ url_for('frontend_static', path='ingestion.js') }}"></script>
{% endblock %}
